syntax = "proto3";

import "google/protobuf/timestamp.proto";
import "google/protobuf/empty.proto";

package message;

service MessageService {
    rpc SendMessage (SendMessageRequest) returns (SendMessageResponse) {}
    rpc UpdateMessage (UpdateMessageRequest) returns (MessageId) {}
    rpc DeleteMessage (DeleteMessageRequest) returns (DeleteMessageResponse) {}
    rpc GetAllMessages (GetAllMessagesRequest) returns (AllMessages) {}
    rpc GetMessageData (MessageId) returns (FullMessageData) {}
    rpc AddReaction (Reaction) returns (google.protobuf.Empty) {}
    rpc RemoveReaction (Reaction) returns (google.protobuf.Empty) {}
}

message MessageId {
    string message_id = 1;
}

message SendMessageRequest {
    int32 user_id = 1;
    int32 chat_id = 3;
    string content = 4;
    string request_id = 5;
    int32 sender_id = 6;
    optional string reply_to = 7;
}

message SendMessageResponse {
    string message_id = 2;
    google.protobuf.Timestamp created_at = 3;
}

message UpdateMessageRequest {
    string message_id = 1;
    string new_content = 2;
    string request_id = 3;
    int32 sender_id = 4;
}

message DeleteMessageRequest {
    string message_id = 1;
    string request_id = 2;
    int32 sender_id = 3;
}

message DeleteMessageResponse {
    string status = 1;
}

message SenderData {
    int32 id = 3;
    string username = 4;
}

message Message {
    string id = 1;
    int32 chat_id = 2;
    SenderData sender = 3;
    string content = 4;
    bool is_read = 5;
    google.protobuf.Timestamp created_at = 6;
    Metadata metadata = 7;
}

message GetAllMessagesRequest {
    int32 chat_id = 1;
}

message AllMessages {
    repeated Message messages = 1;
}

message ReadBy {
    int32 id = 1;
    google.protobuf.Timestamp read_at = 2;
}

message ReactedBy {
    repeated int32 users_id = 1;
}

message ReplyData {
    string message_id = 1;
    int32 user_id = 2;
    string username = 3;
    string preview = 4;
}

message Metadata {
    bool is_edited = 1;
    bool is_pinned = 2;
    optional ReplyData reply_to = 3;
    map<string, ReactedBy> reactions = 4;
}

message FullMessageData {
    string id = 1;
    int32 chat_id = 2;
    int32 user_id = 3;
    string content = 4;
    bool is_read = 5;
    repeated ReadBy read_by = 6;
    google.protobuf.Timestamp created_at = 7;
    Metadata metadata = 8;
}

message Reaction {
    string message_id = 1;
    int32 author = 2;
    string reaction = 3;
}
